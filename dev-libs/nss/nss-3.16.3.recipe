SUMMARY="Mozilla's Network Security Services library that implements PKI support"
DESCRIPTION="
Network Security Services (NSS) is a set of libraries designed to support \
cross-platform development of security-enabled client and server \
applications. Applications built with NSS can support SSL v2 and v3, TLS, \
PKCS #5, PKCS #7, PKCS #11, PKCS #12, S/MIME, X.509 v3 certificates, and \
other security standards.
"
LICENSE="
GNU GPL v2
GNU LGPL v2.1
MPL v2.0
"
COPYRIGHT="Mozilla Foundation"
HOMEPAGE="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS"
SRC_URI="ftp://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/NSS_3_16_3_RTM/src/nss-$portVersion.tar.gz"
CHECKSUM_SHA256="657711ff7a4058043b69019a66f44101d0234eae2b6b80ab900439dbf02add60"
REVISION="1"
ARCHITECTURES="!x86_gcc2 !x86 !x86_64"
SECONDARY_ARCHITECTURES="!x86 !x86_gcc2"
#SOURCE_DIR="nss-$portVersion/nss"

PROVIDES="
	nss$secondaryArchSuffix = $portVersion compat >= 3
	"
REQUIRES="
	haiku$secondaryArchSuffix >= $haikuVersion
	"
BUILD_REQUIRES="
	nspr${secondaryArchSuffix}_devel >= 4
	"
BUILD_PREREQUIRES="
	haiku${secondaryArchSuffix}_devel >= $haikuVersion
	cmd:autoconf
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:awk
	cmd:perl
	cmd:pkg_config$secondaryArchSuffix
	"
	
PATCHES="nss-$portVersion.patchset"

BUILD()
{
	# FIXME: SOURCE_DIR="nss-$portVersion/nss" doesn't work
	cd nss
	
	# FIXME: $secondaryArchSuffix is wrong here (_arch). What should be used?
	myCPPFLAGS="${CPPFLAGS} `pkg-config nspr --cflags`"
	myLDFLAGS="${LDFLAGS} `pkg-config nspr --libs-only-L`"
	
	export BUILD_OPT=1
	#export NSS_USE_SYSTEM_SQLITE=1
	export NSDISTMODE=copy
	#export FREEBL_NO_DEPEND=1
	export ASFLAGS=""
	
	for d in . lib/dbm ; do
		CPPFLAGS="${myCPPFLAGS}"
		LDFLAGS="${myLDFLAGS}"
		make -j1 -C ${d}
	done
}

INSTALL()
{
	cd nss
	make install
}

TEST()
{
	cd nss
	# TODO
}

# ----- devel package -------------------------------------------------------

PROVIDES_devel="
	nss${secondaryArchSuffix}_devel = $portVersion compat >= 3
	"
REQUIRES_devel="
	nss${secondaryArchSuffix} == $portVersion base
	"
