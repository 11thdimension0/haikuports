SUMMARY="Audio and video recording, conversion, and streaming library"
DESCRIPTION="FFmpeg is a complete, cross-platform solution to record, convert and stream audio and video. It includes libavcodec - the leading audio/video codec library."
HOMEPAGE="http://www.ffmpeg.org"
LICENSE="
	GNU LGPL v2.1
	GNU GPL v2
	"
COPYRIGHT="
	2000-2003 Fabrice Bellard
	2003-2012 the FFmpeg developers
	"
SRC_URI="http://www.ffmpeg.org/releases/ffmpeg-0.10.2.tar.bz2"
CHECKSUM_MD5="de1bd5fc4bbf3ef730a5361ee596fedd"
REVISION="2"
ARCHITECTURES="x86_gcc2 ?x86"

PATCHES="ffmpeg-0.10.2-gcc2.patch"

PROVIDES="
	ffmpeg = $portVersion compat >= 0.10
	cmd:ffmpeg = $portVersion compat >= 0.10
	cmd:ffprobe = $portVersion compat >= 0.10
	cmd:ffserver = $portVersion compat >= 0.10
	lib:libavcodec = 53.61.100 compat >= 53
	lib:libavdevice = 53.4.100 compat >= 53
	lib:libavfilter = 2.61.100 compat >= 2
	lib:libavformat = 53.32.100 compat >= 53
	lib:libavutil = 51.35.100 compat >= 51
	lib:libswresample = 0.6.100 compat >= 0
	lib:libswscale = 2.1.100 compat >= 2
	"
REQUIRES="
	haiku >= $haikuVersion
	lib:libogg
	lib:libspeex
	lib:libtheoradec
	lib:libtheoraenc
	lib:libvorbis
	lib:libvorbisenc
	lib:libvpx
	lib:libz
	"
BUILD_REQUIRES="
	devel:libogg
	devel:libspeex
	devel:libtheora
	devel:libvorbis
	devel:libvpx
	devel:libz
	"
BUILD_PREREQUIRES="
	haiku_devel >= $haikuVersion
	cmd:gcc
	cmd:ld
	cmd:make
	cmd:perl
	cmd:pkg_config
	cmd:texi2html
	cmd:yasm
	"

GLOBAL_WRITABLE_FILES="
	settings/ffserver.conf
"

SOURCE_DIR="$portVersionedName"

PATCH()
{
	# patch hard-coded config file path
	sed -i "s,/etc/ffserver.conf,$sysconfDir/ffserver.conf," \
		ffserver.c \
		doc/ffserver.texi

	# patch hard-coded paths to perl
	sed -i "s,/usr/bin/perl,$portPackageLinksDir/cmd:perl/bin/perl," \
		Doxyfile \
		doc/texi2pod.pl
}

BUILD()
{
	# not an auto tools configure
	./configure \
		--prefix=$prefix \
		--datadir=$dataDir/ffmpeg \
		--incdir=$includeDir \
		--mandir=$manDir \
		--disable-debug \
		--enable-shared \
		--enable-libvorbis \
		--enable-libspeex \
		--enable-libtheora \
		--enable-libvpx
	make $jobArgs
}

INSTALL()
{
	make install

	rm $binDir/ffprobe
		# TODO: Determine and fix what is wrong with ffprobe! The executable
		# seems to be broken. The NEEDED entries in the dynamic section look
		# weird and the runtime loader fails relocating with "Operation not
		# allowed".

	prepareInstalledDevelLibs \
		libavcodec \
		libavdevice \
		libavfilter \
		libavformat \
		libavutil \
		libswresample \
		libswscale
	fixPkgconfig

	# include the documented ffserver.conf
	mkdir -p $docDir
	cp doc/ffserver.conf $docDir

	# devel package
	packageEntries devel \
		$developDir
}

# ----- devel package -------------------------------------------------------

SUMMARY_devel="The libtheora development files"
PROVIDES_devel="
	ffmpeg_devel = $portVersion compat >= 0.10
	devel:libavcodec = 53.61.100 compat >= 53
	devel:libavdevice = 53.4.100 compat >= 53
	devel:libavfilter = 2.61.100 compat >= 2
	devel:libavformat = 53.32.100 compat >= 53
	devel:libavutil = 51.35.100 compat >= 51
	devel:libswresample = 0.6.100 compat >= 0
	devel:libswscale = 2.1.100 compat >= 2
	"
REQUIRES_devel="
	ffmpeg == $portVersion
	"
